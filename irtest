#! /bin/bash

set -euo pipefail

main() {
    if [[ $# == 0 ]]; then
        echo "usage: irtest test.xi..."
    fi

    for f in "$@"; do
        nonce=TEMP
        dname=$(dirname $f)
        fname=$(basename $f)
        noext=$(basename $f .xi)
        pervasive_file="$dname/pervasives.xi"

        # don't do anything for temp files
        if [[ "$fname" != "$nonce"* ]]; then
            tempname="$dname/$nonce-$fname"
            cat "$pervasive_file" "$f" > "$tempname"

            outputfiles[0]="$dname/$noext.nothing-out"
            outputfiles[1]="$dname/$noext.astfolded-out"
            outputfiles[2]="$dname/$noext.rawir-out"
            outputfiles[3]="$dname/$noext.irfolded-out"
            outputfiles[4]="$dname/$noext.lowered-out"
            outputfiles[5]="$dname/$noext.ir-out"

            # TODO: run stuff
            libpath="-libpath $dname"
            ./xic --typecheck $libpath "$tempname" || true
            ./xic --irgen --ast-cfold $libpath "$tempname" || true
            ./xic --irgen --ir-cfold $libpath "$tempname" || true
            ./xic --irgen --lower $libpath "$tempname" || true
            ./xic --irgen --blkreorder $libpath "$tempname" || true

            # for ((i = 0; i < ${#outputfiles[*]}; i++)); do
                # for ((j = i+1; j < ${#outputfiles[*]}; j++)); do
                    # filea="${outputfiles[$i]}"
                    # fileb="${outputfiles[$j]}"
                    # if ! diff "$filea" "$fileb" > /dev/null; then
                        # echo "$filea and $fileb" differ
                    # fi
                # done
            # done
        fi
    done
}

main "$@"
